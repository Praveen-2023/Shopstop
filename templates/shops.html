{% extends "base.html" %}

{% block title %}Shops - ShopStop{% endblock %}

{% block page_title %}Shops Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient d-flex justify-content-between align-items-center" style="background: linear-gradient(45deg, #3a1c71, #d76d77, #ffaf7b); color: white;">
                <h5 class="card-title mb-0"><i class="bi bi-shop me-2"></i>Shops Directory</h5>
                <div>
                    <button id="refresh-shops-btn" class="btn btn-light btn-sm me-2">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <button id="add-shop-btn" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#shopModal">
                        <i class="bi bi-plus-circle me-1"></i>Add Shop
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Note:</strong> Only administrators can add, edit, or delete shops. All shop data is stored in the cs432g17 database.
                </div>

                <!-- Search and filter controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="shop-search" placeholder="Search shops..." aria-label="Search shops">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="location-filter">
                            <option value="">All Locations</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex justify-content-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="view-grid-btn">
                                    <i class="bi bi-grid-3x3-gap"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="view-list-btn">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid view (default) -->
                <div id="shops-grid-view" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
                    <div class="col text-center">
                        <div class="card h-100 d-flex justify-content-center align-items-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading shops...</p>
                        </div>
                    </div>
                </div>

                <!-- List view (hidden by default) -->
                <div id="shops-list-view" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Owner</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="shops-table-body">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading shops...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Shop pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="shops-pagination">
                        <!-- Will be populated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Shop Modal -->
<div class="modal fade" id="shopModal" tabindex="-1" aria-labelledby="shopModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shopModalLabel">Add New Shop</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shop-form">
                    <input type="hidden" id="shop-id">
                    <div class="mb-3">
                        <label for="shop-name" class="form-label">Shop Name</label>
                        <input type="text" class="form-control" id="shop-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="shop-address" class="form-label">Address</label>
                        <textarea class="form-control" id="shop-address" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="shop-contact" class="form-label">Contact</label>
                        <input type="text" class="form-control" id="shop-contact" required>
                    </div>
                    <div class="mb-3">
                        <label for="shop-owner" class="form-label">Owner (Member ID)</label>
                        <select class="form-select" id="shop-owner" required>
                            <option value="">Select Member</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-shop-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this shop? This action cannot be undone.</p>
                <input type="hidden" id="delete-shop-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- View Shop Modal -->
<div class="modal fade" id="viewShopModal" tabindex="-1" aria-labelledby="viewShopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(45deg, #3a1c71, #d76d77, #ffaf7b); color: white;">
                <h5 class="modal-title" id="viewShopModalLabel"><i class="bi bi-shop me-2"></i>Shop Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Shop header with banner -->
                <div class="shop-banner p-4 text-center" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                    <div class="shop-icon mb-3">
                        <span class="rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background-color: #e9ecef;">
                            <i class="bi bi-shop" style="font-size: 2.5rem;"></i>
                        </span>
                    </div>
                    <h4 class="shop-name mb-1" id="view-shop-name-header"></h4>
                    <p class="text-muted mb-0" id="view-shop-address-header"></p>
                    <div class="shop-badges mt-2">
                        <span class="badge bg-primary me-1" id="view-shop-id-badge"></span>
                        <span class="badge bg-info" id="view-shop-products-count">0 Products</span>
                    </div>
                </div>

                <div class="row g-0">
                    <!-- Shop Information -->
                    <div class="col-md-5 border-end">
                        <div class="p-4">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-info-circle me-2"></i>Shop Information</h6>
                            <div class="mb-3">
                                <label class="text-muted small">Shop ID</label>
                                <p class="mb-0 fw-bold" id="view-shop-id"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Shop Name</label>
                                <p class="mb-0 fw-bold" id="view-shop-name"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Address</label>
                                <p class="mb-0" id="view-shop-address"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Contact</label>
                                <p class="mb-0">
                                    <a href="tel:" class="text-decoration-none" id="view-shop-contact-link">
                                        <i class="bi bi-telephone me-1"></i>
                                        <span id="view-shop-contact"></span>
                                    </a>
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Owner</label>
                                <div class="d-flex align-items-center">
                                    <div id="view-shop-owner-image" class="me-2" style="width: 40px; height: 40px; border-radius: 50%; background-color: #e9ecef; overflow: hidden;">
                                        <img src="/static/images/members/placeholder.jpg" width="40" height="40" alt="Owner" class="img-fluid">
                                    </div>
                                    <p class="mb-0" id="view-shop-owner"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products -->
                    <div class="col-md-7">
                        <div class="p-4">
                            <h6 class="border-bottom pb-2 mb-3 d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-box me-2"></i>Products</span>
                                <a href="#" class="btn btn-sm btn-outline-primary" id="view-products-btn">
                                    <i class="bi bi-grid me-1"></i>View All
                                </a>
                            </h6>
                            <div id="shop-products-container" class="overflow-auto" style="max-height: 300px;">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading products...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="edit-shop-from-view-btn">
                    <i class="bi bi-pencil me-1"></i>Edit Shop
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check authentication
        if (checkAuth()) {
            // Check if user is admin
            checkAdminRole();

            // Hide admin buttons by default
            document.getElementById('add-shop-btn').style.display = 'none';

            // Load shops
            loadShops();

            // Load members for the owner dropdown
            loadMembers();

            // Event listeners
            document.getElementById('save-shop-btn').addEventListener('click', saveShop);
            document.getElementById('confirm-delete-btn').addEventListener('click', deleteShop);
            document.getElementById('refresh-shops-btn').addEventListener('click', loadShops);

            // Reset form when modal is closed
            const shopModal = document.getElementById('shopModal');
            shopModal.addEventListener('hidden.bs.modal', function() {
                document.getElementById('shop-form').reset();
                document.getElementById('shop-id').value = '';
                document.getElementById('shopModalLabel').textContent = 'Add New Shop';
            });
        }
    });

    // Global variables for pagination and filtering
    let allShops = [];
    let filteredShops = [];
    let currentPage = 1;
    const itemsPerPage = 9;
    let uniqueLocations = new Set();

    function loadShops() {
        const sessionToken = localStorage.getItem('sessionToken');
        const gridView = document.getElementById('shops-grid-view');
        const tableBody = document.getElementById('shops-table-body');

        // Show loading indicators
        gridView.innerHTML = `
            <div class="col text-center">
                <div class="card h-100 d-flex justify-content-center align-items-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading shops...</p>
                </div>
            </div>
        `;

        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading shops...
                </td>
            </tr>
        `;

        fetch('/api/shops', {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Store all shops globally
                allShops = data.data;
                filteredShops = [...allShops];

                // Extract unique locations for the filter dropdown
                uniqueLocations = new Set();
                allShops.forEach(shop => {
                    if (shop.address) {
                        // Extract the main location (first part before comma or first word)
                        const location = shop.address.split(',')[0].trim();
                        uniqueLocations.add(location);
                    }
                });

                // Populate location filter
                populateLocationFilter(uniqueLocations);

                // Display shops
                displayShops(filteredShops, currentPage);

                // Setup search functionality
                setupSearch();

                // Setup view toggle
                setupViewToggle();
            } else {
                showMessage('Error', data.error || 'Failed to load shops');
                gridView.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load shops: ${data.error || 'Unknown error'}
                        </div>
                    </div>
                `;
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load shops: ${data.error || 'Unknown error'}
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading shops:', error);
            showMessage('Error', 'Failed to load shops. Please try again.');
            gridView.innerHTML = `
                <div class="col-12 text-center">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load shops: ${error.message}
                    </div>
                </div>
            `;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load shops: ${error.message}
                    </td>
                </tr>
            `;
        });
    }

    function populateLocationFilter(locations) {
        const locationFilter = document.getElementById('location-filter');

        // Clear existing options except the first one
        while (locationFilter.options.length > 1) {
            locationFilter.remove(1);
        }

        // Add locations to dropdown
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location;
            option.textContent = location;
            locationFilter.appendChild(option);
        });

        // Add event listener
        locationFilter.addEventListener('change', function() {
            filterShops();
        });
    }

    function setupSearch() {
        const searchInput = document.getElementById('shop-search');

        searchInput.addEventListener('input', function() {
            filterShops();
        });
    }

    function filterShops() {
        const searchTerm = document.getElementById('shop-search').value.toLowerCase();
        const locationFilter = document.getElementById('location-filter').value;

        filteredShops = allShops.filter(shop => {
            // Apply search filter
            const matchesSearch =
                shop.name.toLowerCase().includes(searchTerm) ||
                shop.shop_id.toLowerCase().includes(searchTerm) ||
                (shop.address && shop.address.toLowerCase().includes(searchTerm)) ||
                (shop.contact && shop.contact.toLowerCase().includes(searchTerm));

            // Apply location filter
            const matchesLocation = !locationFilter ||
                (shop.address && shop.address.split(',')[0].trim() === locationFilter);

            return matchesSearch && matchesLocation;
        });

        // Reset to first page when filtering
        currentPage = 1;

        // Display filtered shops
        displayShops(filteredShops, currentPage);
    }

    function setupViewToggle() {
        const gridBtn = document.getElementById('view-grid-btn');
        const listBtn = document.getElementById('view-list-btn');
        const gridView = document.getElementById('shops-grid-view');
        const listView = document.getElementById('shops-list-view');

        gridBtn.addEventListener('click', function() {
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
            gridView.classList.remove('d-none');
            listView.classList.add('d-none');
        });

        listBtn.addEventListener('click', function() {
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
            listView.classList.remove('d-none');
            gridView.classList.add('d-none');
        });
    }

    function displayShops(shops, page) {
        const gridView = document.getElementById('shops-grid-view');
        const tableBody = document.getElementById('shops-table-body');
        const pagination = document.getElementById('shops-pagination');

        // Calculate pagination
        const totalPages = Math.ceil(shops.length / itemsPerPage);
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, shops.length);
        const currentShops = shops.slice(startIndex, endIndex);

        // Display in grid view
        if (shops.length === 0) {
            gridView.innerHTML = `
                <div class="col-12 text-center">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No shops found matching your criteria.
                    </div>
                </div>
            `;
        } else {
            gridView.innerHTML = '';

            currentShops.forEach(shop => {
                const shopCard = document.createElement('div');
                shopCard.className = 'col';

                // Generate a random gradient for the shop card header
                const gradients = [
                    'linear-gradient(45deg, #3a1c71, #d76d77, #ffaf7b)',
                    'linear-gradient(45deg, #00b09b, #96c93d)',
                    'linear-gradient(45deg, #fc4a1a, #f7b733)',
                    'linear-gradient(45deg, #4facfe, #00f2fe)',
                    'linear-gradient(45deg, #667eea, #764ba2)',
                    'linear-gradient(45deg, #ff9a9e, #fad0c4)',
                    'linear-gradient(45deg, #a18cd1, #fbc2eb)',
                    'linear-gradient(45deg, #ff9a9e, #fecfef)',
                    'linear-gradient(45deg, #f093fb, #f5576c)'
                ];
                const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];

                // Extract the main location (first part before comma or first word)
                const location = shop.address ? shop.address.split(',')[0].trim() : 'Unknown';

                shopCard.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="card-header text-white p-3" style="background: ${randomGradient}">
                            <h5 class="card-title mb-0">${shop.name}</h5>
                            <small class="opacity-75">${shop.shop_id}</small>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="bi bi-geo-alt text-muted me-2"></i>
                                <span class="text-muted">${shop.address || 'No address'}</span>
                            </div>
                            <div class="mb-3">
                                <i class="bi bi-telephone text-muted me-2"></i>
                                <a href="tel:${shop.contact}" class="text-decoration-none">${shop.contact || 'No contact'}</a>
                            </div>
                            <div class="mb-3 d-flex align-items-center">
                                <div class="owner-image-${shop.shop_id} me-2" style="width: 32px; height: 32px; border-radius: 50%; background-color: #e9ecef; overflow: hidden;">
                                    <img src="/static/images/members/placeholder.jpg" width="32" height="32" alt="Owner" class="img-fluid">
                                </div>
                                <span class="owner-placeholder-${shop.shop_id}">Loading owner...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <span class="badge bg-light text-dark">${location}</span>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary view-shop-btn" data-shop-id="${shop.shop_id}">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning edit-shop-btn" data-shop-id="${shop.shop_id}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-shop-btn" data-shop-id="${shop.shop_id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                gridView.appendChild(shopCard);

                // Fetch owner name
                // if (shop.member_id) {
                //     fetchOwnerName(shop.member_id, shop.shop_id);
                // } else {
                    document.querySelector(`.owner-placeholder-${shop.shop_id}`).textContent = 'No owner';
                // }
            });

            // Add event listeners to buttons
            document.querySelectorAll('.view-shop-btn').forEach(btn => {
                btn.addEventListener('click', () => viewShop(btn.dataset.shopId));
            });

            document.querySelectorAll('.edit-shop-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const shop = allShops.find(s => s.shop_id === btn.dataset.shopId);
                    if (shop) editShop(shop);
                });
            });

            document.querySelectorAll('.delete-shop-btn').forEach(btn => {
                btn.addEventListener('click', () => showDeleteModal(btn.dataset.shopId));
            });
        }

        // Display in list view
        if (shops.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <i class="bi bi-info-circle me-2"></i>
                        No shops found matching your criteria.
                    </td>
                </tr>
            `;
        } else {
            tableBody.innerHTML = '';

            currentShops.forEach(shop => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = shop.shop_id;

                const nameCell = document.createElement('td');
                nameCell.textContent = shop.name;

                const addressCell = document.createElement('td');
                addressCell.textContent = shop.address || 'No address';

                const contactCell = document.createElement('td');
                contactCell.innerHTML = `<a href="tel:${shop.contact}" class="text-decoration-none">${shop.contact || 'No contact'}</a>`;

                const ownerCell = document.createElement('td');
                ownerCell.innerHTML = `<span class="list-owner-placeholder-${shop.shop_id}">Loading...</span>`;

                const actionsCell = document.createElement('td');

                // View button
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-info me-1';
                viewBtn.innerHTML = '<i class="bi bi-eye"></i>';
                viewBtn.title = 'View Shop';
                // viewBtn.addEventListener('click', () => viewShop(shop.shop_id));

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-warning me-1';
                editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                editBtn.title = 'Edit Shop';
                editBtn.addEventListener('click', () => editShop(shop));

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-danger';
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.title = 'Delete Shop';
                deleteBtn.addEventListener('click', () => showDeleteModal(shop.shop_id));

                // Always show view button
                actionsCell.appendChild(viewBtn);

                // Only show edit/delete buttons for admins
                const userRole = localStorage.getItem('userRole');
                if (userRole && userRole.toLowerCase() === 'admin') {
                    actionsCell.appendChild(editBtn);
                    actionsCell.appendChild(deleteBtn);
                }

                row.appendChild(idCell);
                row.appendChild(nameCell);
                row.appendChild(addressCell);
                row.appendChild(contactCell);
                row.appendChild(ownerCell);
                row.appendChild(actionsCell);

                tableBody.appendChild(row);

                // Fetch owner name for list view
                // if (shop.member_id) {
                //     fetchOwnerNameForList(shop.member_id, shop.shop_id);
                // } else {
                    document.querySelector(`.list-owner-placeholder-${shop.shop_id}`).textContent = 'No owner';
                // }
            });
        }

        // Update pagination
        updatePagination(totalPages, page);
    }

    function fetchOwnerName(memberId, shopId) {
        const sessionToken = localStorage.getItem('sessionToken');

        // Set a default placeholder while loading
        const ownerPlaceholder = document.querySelector(`.owner-placeholder-${shopId}`);
        if (ownerPlaceholder) {
            ownerPlaceholder.innerHTML = `<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Loading...</span>`;
        }

        // Set a default image while loading
        const ownerImage = document.querySelector(`.owner-image-${shopId} img`);
        if (ownerImage) {
            ownerImage.src = '/static/images/members/placeholder.jpg';
            ownerImage.alt = 'Loading...';
        }

        fetch(`/portfolio/member-details/${memberId}`, {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Member data for shop', shopId, ':', data); // Debug log

            if (ownerPlaceholder) {
                if (data.status === 'success' && data.data) {
                    // Update owner name
                    ownerPlaceholder.textContent = data.data.name || `ID: ${memberId}`;

                    // Update owner image if available
                    if (data.data.profile_image && ownerImage) {
                        ownerImage.src = data.data.profile_image;
                        ownerImage.alt = data.data.name || `Member ${memberId}`;

                        // Add tooltip with more information
                        const parentDiv = ownerImage.parentElement;
                        if (parentDiv) {
                            parentDiv.title = `${data.data.name} (${data.data.gender || 'unknown'})
Image: ${data.data.image_file || 'unknown'}
Email: ${data.data.email || 'N/A'}`;
                        }
                    }
                } else {
                    console.error('Error in member data:', data);
                    ownerPlaceholder.textContent = `ID: ${memberId}`;

                    // Show error message
                    showMessage('Warning', 'Could not load member details. Using ID instead.');
                }
            }
        })
        .catch(error => {
            console.error('Error fetching member:', error);
            if (ownerPlaceholder) {
                ownerPlaceholder.textContent = `ID: ${memberId}`;
            }

            // Show error message
            showMessage('Error', 'Failed to load member profile. Please try again.');
        });
    }

    function fetchOwnerNameForList(memberId, shopId) {
        const sessionToken = localStorage.getItem('sessionToken');

        // Set a default placeholder while loading
        const ownerPlaceholder = document.querySelector(`.list-owner-placeholder-${shopId}`);
        if (ownerPlaceholder) {
            ownerPlaceholder.innerHTML = `<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Loading...</span>`;
        }
    }

    function checkAdminRole() {
        const sessionToken = localStorage.getItem('sessionToken');

        fetch('/check-role')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Store role in localStorage for future use
                localStorage.setItem('userRole', data.role);

                // Show/hide admin-only elements based on role
                const isAdmin = data.is_admin;
                const addShopBtn = document.getElementById('add-shop-btn');

                if (isAdmin) {
                    // Show admin-only elements
                    addShopBtn.style.display = 'block';

                    // Update UI to show admin controls
                    document.querySelectorAll('.edit-shop-btn, .delete-shop-btn').forEach(btn => {
                        btn.style.display = 'inline-block';
                    });
                } else {
                    // Hide admin-only elements
                    addShopBtn.style.display = 'none';

                    // Update UI to hide admin controls
                    document.querySelectorAll('.edit-shop-btn, .delete-shop-btn').forEach(btn => {
                        btn.style.display = 'none';
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error checking role:', error);
        });
    }

    function fetchOwnerDetailsForList(memberId, shopId) {
        const sessionToken = localStorage.getItem('sessionToken');
        const ownerPlaceholder = document.querySelector(`.list-owner-placeholder-${shopId}`);

        if (!ownerPlaceholder) return;

        fetch(`/portfolio/member-details/${memberId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (ownerPlaceholder) {
                if (data.status === 'success' && data.data) {
                    // Create HTML with image and name
                    if (data.data.profile_image) {
                        ownerPlaceholder.innerHTML = `
                            <img src="${data.data.profile_image}" width="24" height="24"
                                 alt="${data.data.name || `Member ${memberId}`}"
                                 class="rounded-circle me-1"
                                 title="${data.data.name} (${data.data.gender || 'unknown'})\nImage: ${data.data.image_file || 'unknown'}">
                            ${data.data.name || `ID: ${memberId}`}
                        `;
                    } else {
                        ownerPlaceholder.textContent = data.data.name || `ID: ${memberId}`;
                    }
                } else {
                    console.error('Error in member data for list:', data);
                    ownerPlaceholder.textContent = `ID: ${memberId}`;

                    // Log the error but don't show a message to avoid too many alerts
                    console.warn('Could not load member details for list view. Using ID instead.');
                }
            }
        })
        .catch(error => {
            console.error('Error fetching member:', error);
            if (ownerPlaceholder) {
                ownerPlaceholder.textContent = `ID: ${memberId}`;
            }

            // Log the error but don't show a message to avoid too many alerts
            console.warn('Failed to load member profile for list view.');
        });
    }

    function updatePagination(totalPages, currentPage) {
        const pagination = document.getElementById('shops-pagination');
        pagination.innerHTML = '';

        if (totalPages <= 1) {
            return; // No pagination needed
        }

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
        prevLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });
        pagination.appendChild(prevLi);

        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', function(e) {
                e.preventDefault();
                goToPage(i);
            });
            pagination.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
        nextLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });
        pagination.appendChild(nextLi);
    }

    function goToPage(page) {
        currentPage = page;
        displayShops(filteredShops, currentPage);

        // Scroll to top of shops section
        document.querySelector('.card-body').scrollIntoView({ behavior: 'smooth' });
    }

    function loadMembers() {
        const sessionToken = localStorage.getItem('sessionToken');

        fetch('/portfolio/members', {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const ownerSelect = document.getElementById('shop-owner');

                // Clear existing options except the first one
                while (ownerSelect.options.length > 1) {
                    ownerSelect.remove(1);
                }

                // Add members to dropdown
                data.data.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.member_id;
                    option.textContent = `${member.username} (ID: ${member.member_id})`;
                    ownerSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading members:', error);
        });
    }

    function saveShop() {
        const sessionToken = localStorage.getItem('sessionToken');
        const shopId = document.getElementById('shop-id').value;

        // Generate a unique shop ID if not editing
        const uniqueShopId = shopId || 'SH' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');

        const shopData = {
            shop_id: uniqueShopId,
            name: document.getElementById('shop-name').value,
            address: document.getElementById('shop-address').value,
            contact: document.getElementById('shop-contact').value,
            member_id: document.getElementById('shop-owner').value
        };

        let url = '/api/shops';
        let method = 'POST';

        if (shopId) {
            // This would be an update
            method = 'PUT';
            url = `/api/shops/${shopId}`;
        }

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
                // Session token will be added by the fetch interceptor
            },
            body: JSON.stringify(shopData)
        })
        .then(response => {
            if (response.status === 403) {
                throw new Error('Admin access required');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showMessage('Error', data.error);
            } else {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('shopModal'));
                modal.hide();

                // Reload shops
                loadShops();

                showMessage('Success', 'Shop saved successfully');
            }
        })
        .catch(error => {
            console.error('Error saving shop:', error);
            showMessage('Error', error.message || 'Failed to save shop. Please try again.');
        });
    }

    function viewShop(shopId) {
        const sessionToken = localStorage.getItem('sessionToken');

        fetch(`/api/shops/${shopId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const shop = data.data;

                // Update shop details in the modal
                document.getElementById('view-shop-id').textContent = shop.shop_id;
                document.getElementById('view-shop-name').textContent = shop.name;
                document.getElementById('view-shop-name-header').textContent = shop.name;
                document.getElementById('view-shop-address').textContent = shop.address || 'No address';
                document.getElementById('view-shop-address-header').textContent = shop.address || 'No address';
                document.getElementById('view-shop-contact').textContent = shop.contact || 'No contact';
                document.getElementById('view-shop-contact-link').href = `tel:${shop.contact}`;
                document.getElementById('view-shop-id-badge').textContent = shop.shop_id;

                // Handle owner display
                if (shop.member_id) {
                    // If we have a member_id, try to fetch the member name
                    // Set a default placeholder while loading
                    document.getElementById('view-shop-owner').innerHTML = `<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Loading...</span>`;

                    // Set a default image while loading
                    const ownerImage = document.querySelector('#view-shop-owner-image img');
                    if (ownerImage) {
                        ownerImage.src = '/static/images/members/placeholder.jpg';
                        ownerImage.alt = 'Loading...';
                    }

                    fetch(`/portfolio/member-details/${shop.member_id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Member data for view shop', shop.shop_id, ':', data); // Debug log
                        if (data.status === 'success' && data.data) {
                            document.getElementById('view-shop-owner').textContent = data.data.name || `ID: ${shop.member_id}`;

                            // Update owner image if available
                            if (data.data.profile_image) {
                                const ownerImage = document.querySelector('#view-shop-owner-image img');
                                if (ownerImage) {
                                    ownerImage.src = data.data.profile_image;
                                    ownerImage.alt = data.data.name || `Member ${shop.member_id}`;

                                    // Add tooltip with more information
                                    const parentDiv = ownerImage.parentElement;
                                    if (parentDiv) {
                                        parentDiv.title = `${data.data.name} (${data.data.gender || 'unknown'})
Image: ${data.data.image_file || 'unknown'}
Email: ${data.data.email || 'N/A'}`;
                                    }

                                    // Add a small badge indicating the image file
                                    const ownerSection = document.querySelector('#view-shop-owner').parentElement;
                                    if (ownerSection) {
                                        // Remove any existing badge
                                        const existingBadge = ownerSection.querySelector('.image-badge');
                                        if (existingBadge) {
                                            existingBadge.remove();
                                        }

                                        // Add new badge
                                        const badge = document.createElement('span');
                                        badge.className = 'badge bg-secondary ms-2 image-badge';
                                        badge.textContent = data.data.image_file || 'unknown';
                                        badge.style.fontSize = '0.7rem';
                                        ownerSection.appendChild(badge);
                                    }
                                }
                            }
                        } else {
                            console.error('Error in member data for view shop:', data);
                            document.getElementById('view-shop-owner').textContent = `ID: ${shop.member_id}`;

                            // Show warning message
                            showMessage('Warning', 'Could not load member details. Using ID instead.');

                            // Reset the owner image
                            const ownerImage = document.querySelector('#view-shop-owner-image img');
                            if (ownerImage) {
                                ownerImage.src = '/static/images/members/placeholder.jpg';
                                ownerImage.alt = `Member ${shop.member_id}`;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching member:', error);
                        document.getElementById('view-shop-owner').textContent = `ID: ${shop.member_id}`;

                        // Show error message
                        showMessage('Error', 'Failed to load member profile. Please try again.');

                        // Reset the owner image
                        const ownerImage = document.querySelector('#view-shop-owner-image img');
                        if (ownerImage) {
                            ownerImage.src = '/static/images/members/placeholder.jpg';
                            ownerImage.alt = `Member ${shop.member_id}`;
                        }
                    });
                } else {
                    document.getElementById('view-shop-owner').textContent = 'No owner';
                }

                // Update the products link
                document.getElementById('view-products-btn').href = `/products?shop=${shop.shop_id}`;

                // Setup edit button in view modal
                const editFromViewBtn = document.getElementById('edit-shop-from-view-btn');
                if (editFromViewBtn) {
                    // Only show edit button for admins
                    const userRole = localStorage.getItem('userRole');
                    if (userRole && userRole.toLowerCase() === 'admin') {
                        editFromViewBtn.style.display = 'block';
                        editFromViewBtn.onclick = () => {
                            // Close view modal
                            bootstrap.Modal.getInstance(document.getElementById('viewShopModal')).hide();
                            // Open edit modal
                            setTimeout(() => editShop(shop), 500);
                        };
                    } else {
                        editFromViewBtn.style.display = 'none';
                    }
                }

                // Load products for this shop
                loadShopProducts(shop.shop_id);

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('viewShopModal'));
                modal.show();
            } else {
                showMessage('Error', data.error || 'Failed to load shop details');
            }
        })
        .catch(error => {
            console.error('Error loading shop details:', error);
            showMessage('Error', 'Failed to load shop details. Please try again.');
        });
    }

    function loadShopProducts(shopId) {
        const sessionToken = localStorage.getItem('sessionToken');
        const productsContainer = document.getElementById('shop-products-container');

        // Show loading indicator
        productsContainer.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading products...</p>
            </div>
        `;

        // Fetch products for this shop from cs432g17 database
        fetch(`/api/products?shop_id=${shopId}`, {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.data && data.data.length > 0) {
                const products = data.data;
                productsContainer.innerHTML = '';

                const list = document.createElement('ul');
                list.className = 'list-group';

                products.forEach(product => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';

                    const content = document.createElement('div');
                    content.innerHTML = `
                        <strong>${product.name}</strong> (${product.product_id})<br>
                        <small>Category: ${product.category || 'N/A'}</small><br>
                        <small>Price: ${parseFloat(product.price).toFixed(2)}</small>
                    `;

                    const badge = document.createElement('span');
                    badge.className = `badge ${parseInt(product.stock_quantity) <= 5 ? 'bg-warning' : 'bg-success'} rounded-pill`;
                    badge.textContent = `Stock: ${product.stock_quantity}`;

                    item.appendChild(content);
                    item.appendChild(badge);
                    list.appendChild(item);
                });

                productsContainer.appendChild(list);

                // Update products count badge
                document.getElementById('view-shop-products-count').textContent = `${products.length} Products`;
                document.getElementById('view-shop-products-count').className = 'badge bg-success';
            } else {
                productsContainer.innerHTML = '<p class="text-center">No products found for this shop.</p>';

                // Update products count badge
                document.getElementById('view-shop-products-count').textContent = '0 Products';
                document.getElementById('view-shop-products-count').className = 'badge bg-secondary';
            }
        })
        .catch(error => {
            console.error('Error loading shop products:', error);
            productsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load products. Please try again.
                </div>
            `;
        });
    }

    function editShop(shop) {
        // Check if user is admin
        const userRole = localStorage.getItem('userRole');
        if (userRole && userRole.toLowerCase() !== 'admin') {
            showMessage('Error', 'Admin access required to edit shops');
            return;
        }

        // Set form values
        document.getElementById('shop-id').value = shop.shop_id;
        document.getElementById('shop-name').value = shop.name;
        document.getElementById('shop-address').value = shop.address;
        document.getElementById('shop-contact').value = shop.contact;
        document.getElementById('shop-owner').value = shop.member_id;

        // Update modal title
        document.getElementById('shopModalLabel').textContent = 'Edit Shop';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('shopModal'));
        modal.show();
    }

    function showDeleteModal(shopId) {
        // Check if user is admin
        const userRole = localStorage.getItem('userRole');
        if (userRole && userRole.toLowerCase() !== 'admin') {
            showMessage('Error', 'Admin access required to delete shops');
            return;
        }

        document.getElementById('delete-shop-id').value = shopId;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    function deleteShop() {
        const sessionToken = localStorage.getItem('sessionToken');
        const shopId = document.getElementById('delete-shop-id').value;

        fetch(`/api/shops/${shopId}`, {
            method: 'DELETE'
            // Session token will be added by the fetch interceptor
        })
        .then(response => {
            if (response.status === 403) {
                throw new Error('Admin access required');
            }
            return response.json();
        })
        .then(data => {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();

            if (data.error) {
                showMessage('Error', data.error);
            } else {
                // Reload shops
                loadShops();

                showMessage('Success', data.message || 'Shop deleted successfully');
            }
        })
        .catch(error => {
            console.error('Error deleting shop:', error);
            showMessage('Error', error.message || 'Failed to delete shop. Please try again.');
        });
    }
</script>
{% endblock %}
