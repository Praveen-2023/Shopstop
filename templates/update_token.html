{% extends "base.html" %}

{% block title %}Update Session Token - ShopStop{% endblock %}

{% block page_title %}Update Session Token{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="bi bi-key me-2"></i>Update Session Token</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <p>This page will help you update your session token to fix authentication issues.</p>
                </div>
                
                <div class="mb-3">
                    <label for="session-token" class="form-label">New Session Token</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="session-token" value="db105d2f-e801-4b12-818b-5cba31b9797a">
                        <button class="btn btn-outline-secondary" type="button" id="paste-token-btn">Paste</button>
                    </div>
                    <div class="form-text">Enter the new session token generated by the update_session.py script.</div>
                </div>
                
                <div class="mb-3">
                    <label for="expiry" class="form-label">Expiry Timestamp</label>
                    <input type="text" class="form-control" id="expiry" value="1744906203">
                    <div class="form-text">Enter the expiry timestamp from the update_session.py script.</div>
                </div>
                
                <div class="mb-3">
                    <label for="user-role" class="form-label">User Role</label>
                    <select class="form-select" id="user-role">
                        <option value="Admin" selected>Admin</option>
                        <option value="User">User</option>
                    </select>
                </div>
                
                <button id="update-token-btn" class="btn btn-primary">Update Session Token</button>
                
                <div id="result" class="mt-3" style="display: none;"></div>
                
                <div class="mt-4">
                    <h6>Current LocalStorage Values:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="localStorage-data">
                                <tr>
                                    <td colspan="2" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Display localStorage contents
        displayLocalStorage();
        
        // Add event listeners
        document.getElementById('update-token-btn').addEventListener('click', updateToken);
        document.getElementById('paste-token-btn').addEventListener('click', pasteFromClipboard);
    });
    
    function displayLocalStorage() {
        const tableBody = document.getElementById('localStorage-data');
        tableBody.innerHTML = '';
        
        // Get all localStorage items
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            let value = localStorage.getItem(key);
            
            // Create table row
            const row = document.createElement('tr');
            
            const keyCell = document.createElement('td');
            keyCell.textContent = key;
            
            const valueCell = document.createElement('td');
            valueCell.textContent = value;
            
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            tableBody.appendChild(row);
        }
        
        if (localStorage.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="2" class="text-center">No data in localStorage</td></tr>';
        }
    }
    
    function updateToken() {
        const sessionToken = document.getElementById('session-token').value.trim();
        const expiry = document.getElementById('expiry').value.trim();
        const userRole = document.getElementById('user-role').value;
        
        if (!sessionToken) {
            showResult('error', 'Please enter a session token');
            return;
        }
        
        if (!expiry) {
            showResult('error', 'Please enter an expiry timestamp');
            return;
        }
        
        // Update localStorage
        localStorage.setItem('sessionToken', sessionToken);
        localStorage.setItem('expiry', expiry);
        localStorage.setItem('userRole', userRole);
        
        // Display updated localStorage
        displayLocalStorage();
        
        // Show success message
        showResult('success', 'Session token updated successfully! <a href="/shop-dashboard" class="alert-link">Go to Shop Dashboard</a> to test it.');
    }
    
    function pasteFromClipboard() {
        navigator.clipboard.readText()
            .then(text => {
                document.getElementById('session-token').value = text.trim();
            })
            .catch(err => {
                showResult('error', 'Failed to read from clipboard: ' + err);
            });
    }
    
    function showResult(type, message) {
        const resultDiv = document.getElementById('result');
        resultDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
        resultDiv.innerHTML = message;
        resultDiv.style.display = 'block';
    }
</script>
{% endblock %}
