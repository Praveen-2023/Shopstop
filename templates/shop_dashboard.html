{% extends "base.html" %}

{% block title %}Shop Dashboard - ShopStop{% endblock %}

{% block page_title %}Shop Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-shop me-2"></i>Shops Management</h5>
                <button id="add-shop-btn" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#shopModal">
                    <i class="bi bi-plus-circle me-1"></i>Add Shop
                </button>
            </div>
            <div class="card-body">
                <!-- Search and filter controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="shop-search" placeholder="Search shops..." aria-label="Search shops">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="location-filter">
                            <option value="">All Locations</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button id="refresh-shops-btn" class="btn btn-outline-primary w-100">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Shops Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Shop ID</th>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Contact</th>
                                <th>Owner ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shops-table-body">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading shops...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Shop pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="shops-pagination">
                        <!-- Will be populated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Shop Modal for Add/Edit -->
<div class="modal fade" id="shopModal" tabindex="-1" aria-labelledby="shopModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="shopModalLabel">Add New Shop</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shop-form">
                    <input type="hidden" id="shop-id">
                    <div class="mb-3">
                        <label for="shop-name" class="form-label">Shop Name</label>
                        <input type="text" class="form-control" id="shop-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="shop-address" class="form-label">Address</label>
                        <textarea class="form-control" id="shop-address" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="shop-contact" class="form-label">Contact</label>
                        <input type="text" class="form-control" id="shop-contact" required>
                    </div>
                    <div class="mb-3">
                        <label for="shop-owner" class="form-label">Owner (Member ID)</label>
                        <select class="form-select" id="shop-owner" required>
                            <option value="">Select Member</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-shop-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this shop? This action cannot be undone.</p>
                <p><strong>Shop: </strong><span id="delete-shop-name"></span></p>
                <input type="hidden" id="delete-shop-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Message content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- View Shop Modal -->
<div class="modal fade" id="viewShopModal" tabindex="-1" aria-labelledby="viewShopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewShopModalLabel"><i class="bi bi-shop me-2"></i>Shop Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Shop Information</h6>
                        <div class="mb-3">
                            <label class="text-muted small">Shop ID</label>
                            <p class="mb-0 fw-bold" id="view-shop-id"></p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Shop Name</label>
                            <p class="mb-0 fw-bold" id="view-shop-name"></p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Address</label>
                            <p class="mb-0" id="view-shop-address"></p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Contact</label>
                            <p class="mb-0" id="view-shop-contact"></p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Owner ID</label>
                            <p class="mb-0" id="view-shop-owner"></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Products</h6>
                        <div id="shop-products-container" class="overflow-auto" style="max-height: 300px;">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading products...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="edit-shop-from-view-btn">
                    <i class="bi bi-pencil me-1"></i>Edit Shop
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fix role capitalization if needed
        const userRole = localStorage.getItem('userRole');
        if (userRole && userRole.toLowerCase() === 'admin' && userRole !== 'Admin') {
            console.log('Fixing admin role capitalization from', userRole, 'to Admin');
            localStorage.setItem('userRole', 'Admin');
        }

        // Check authentication
        if (checkAuth()) {
            // All users can perform CRUD operations
            const userRole = localStorage.getItem('userRole');
            console.log('User role:', userRole);

            // Show add shop button for all users
            document.getElementById('add-shop-btn').style.display = 'block';

            // Load shops
            loadShops();

            // Load members for the owner dropdown
            loadMembers();

            // Event listeners
            document.getElementById('save-shop-btn').addEventListener('click', saveShop);
            document.getElementById('confirm-delete-btn').addEventListener('click', deleteShop);
            document.getElementById('refresh-shops-btn').addEventListener('click', loadShops);
            document.getElementById('shop-search').addEventListener('input', filterShops);
            document.getElementById('location-filter').addEventListener('change', filterShops);
            document.getElementById('edit-shop-from-view-btn').addEventListener('click', function() {
                const shopId = document.getElementById('view-shop-id').textContent;
                const shop = allShops.find(s => s.shop_id === shopId);
                if (shop) {
                    // Close view modal
                    bootstrap.Modal.getInstance(document.getElementById('viewShopModal')).hide();
                    // Open edit modal
                    setTimeout(() => editShop(shop), 500);
                }
            });

            // Reset form when modal is closed
            const shopModal = document.getElementById('shopModal');
            shopModal.addEventListener('hidden.bs.modal', function() {
                document.getElementById('shop-form').reset();
                document.getElementById('shop-id').value = '';
                document.getElementById('shopModalLabel').textContent = 'Add New Shop';
            });
        }
    });

    // Global variables for pagination and filtering
    let allShops = [];
    let filteredShops = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let uniqueLocations = new Set();

    function loadShops() {
        const sessionToken = localStorage.getItem('sessionToken');
        const tableBody = document.getElementById('shops-table-body');

        // Show loading indicator
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading shops...
                </td>
            </tr>
        `;

        fetch('/shops', {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Store all shops globally
                allShops = data.data;
                filteredShops = [...allShops];

                // Extract unique locations for the filter dropdown
                uniqueLocations = new Set();
                allShops.forEach(shop => {
                    if (shop.address) {
                        // Extract the main location (first part before comma or first word)
                        const location = shop.address.split(',')[0].trim();
                        uniqueLocations.add(location);
                    }
                });

                // Populate location filter
                populateLocationFilter(uniqueLocations);

                // Display shops
                displayShops(filteredShops, currentPage);
            } else {
                showMessage('Error', data.error || 'Failed to load shops');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load shops: ${data.error || 'Unknown error'}
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading shops:', error);
            showMessage('Error', 'Failed to load shops. Please try again.');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load shops: ${error.message}
                    </td>
                </tr>
            `;
        });
    }

    function populateLocationFilter(locations) {
        const locationFilter = document.getElementById('location-filter');

        // Clear existing options except the first one
        while (locationFilter.options.length > 1) {
            locationFilter.remove(1);
        }

        // Add locations to dropdown
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location;
            option.textContent = location;
            locationFilter.appendChild(option);
        });
    }

    function filterShops() {
        const searchTerm = document.getElementById('shop-search').value.toLowerCase();
        const locationFilter = document.getElementById('location-filter').value;

        filteredShops = allShops.filter(shop => {
            // Apply search filter
            const matchesSearch =
                shop.name.toLowerCase().includes(searchTerm) ||
                shop.shop_id.toLowerCase().includes(searchTerm) ||
                (shop.address && shop.address.toLowerCase().includes(searchTerm)) ||
                (shop.contact && shop.contact.toLowerCase().includes(searchTerm));

            // Apply location filter
            const matchesLocation = !locationFilter ||
                (shop.address && shop.address.split(',')[0].trim() === locationFilter);

            return matchesSearch && matchesLocation;
        });

        // Reset to first page when filtering
        currentPage = 1;

        // Display filtered shops
        displayShops(filteredShops, currentPage);
    }

    function displayShops(shops, page) {
        const tableBody = document.getElementById('shops-table-body');
        const pagination = document.getElementById('shops-pagination');

        // Calculate pagination
        const totalPages = Math.ceil(shops.length / itemsPerPage);
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, shops.length);
        const currentShops = shops.slice(startIndex, endIndex);

        // Clear the table body
        tableBody.innerHTML = '';

        // Display in table view
        if (shops.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <i class="bi bi-info-circle me-2"></i>
                        No shops found matching your criteria.
                    </td>
                </tr>
            `;
        } else {
            // Create rows for current shops
            currentShops.forEach(shop => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = shop.shop_id;

                const nameCell = document.createElement('td');
                nameCell.textContent = shop.name;

                const addressCell = document.createElement('td');
                addressCell.textContent = shop.address || 'No address';

                const contactCell = document.createElement('td');
                contactCell.innerHTML = `<a href="tel:${shop.contact}" class="text-decoration-none">${shop.contact || 'No contact'}</a>`;

                const ownerCell = document.createElement('td');
                ownerCell.textContent = shop.member_id || 'N/A';

                const actionsCell = document.createElement('td');

                // View button
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-info me-1';
                viewBtn.innerHTML = '<i class="bi bi-eye"></i>';
                viewBtn.title = 'View Shop';
                viewBtn.addEventListener('click', () => viewShop(shop.shop_id));

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-warning me-1';
                editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                editBtn.title = 'Edit Shop';
                editBtn.addEventListener('click', () => editShop(shop));

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-danger';
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.title = 'Delete Shop';
                deleteBtn.addEventListener('click', () => showDeleteModal(shop));

                // Show all action buttons for all users
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);

                row.appendChild(idCell);
                row.appendChild(nameCell);
                row.appendChild(addressCell);
                row.appendChild(contactCell);
                row.appendChild(ownerCell);
                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });

            // If we have fewer than itemsPerPage items, add empty rows to maintain table height
            const emptyRowsNeeded = itemsPerPage - currentShops.length;
            if (emptyRowsNeeded > 0 && shops.length > 0) {
                for (let i = 0; i < emptyRowsNeeded; i++) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'empty-row';
                    emptyRow.style.height = '53px'; // Approximate height of a normal row

                    // Add empty cells
                    for (let j = 0; j < 6; j++) {
                        const emptyCell = document.createElement('td');
                        emptyCell.innerHTML = '&nbsp;';
                        emptyRow.appendChild(emptyCell);
                    }

                    tableBody.appendChild(emptyRow);
                }
            }
        }

        // Update pagination
        updatePagination(totalPages, page);
    }

    function updatePagination(totalPages, currentPage) {
        const pagination = document.getElementById('shops-pagination');
        pagination.innerHTML = '';

        if (totalPages <= 1) {
            return; // No pagination needed
        }

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
        prevLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });
        pagination.appendChild(prevLi);

        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', function(e) {
                e.preventDefault();
                goToPage(i);
            });
            pagination.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
        nextLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });
        pagination.appendChild(nextLi);
    }

    function goToPage(page) {
        currentPage = page;
        displayShops(filteredShops, currentPage);
    }

    function loadMembers() {
        const sessionToken = localStorage.getItem('sessionToken');

        fetch('/portfolio/members', {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const ownerSelect = document.getElementById('shop-owner');

                // Clear existing options except the first one
                while (ownerSelect.options.length > 1) {
                    ownerSelect.remove(1);
                }

                // Add members to dropdown
                data.data.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.member_id;
                    option.textContent = `${member.username || member.name || 'Member'} (ID: ${member.member_id})`;
                    ownerSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading members:', error);
        });
    }

    function viewShop(shopId) {
        const sessionToken = localStorage.getItem('sessionToken');

        fetch(`/shops/${shopId}`, {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const shop = data.data;

                // Update shop details in the modal
                document.getElementById('view-shop-id').textContent = shop.shop_id;
                document.getElementById('view-shop-name').textContent = shop.name;
                document.getElementById('view-shop-address').textContent = shop.address || 'No address';
                document.getElementById('view-shop-contact').textContent = shop.contact || 'No contact';
                document.getElementById('view-shop-owner').textContent = shop.member_id || 'No owner';

                // Load products for this shop
                loadShopProducts(shop.shop_id);

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('viewShopModal'));
                modal.show();
            } else {
                showMessage('Error', data.error || 'Failed to load shop details');
            }
        })
        .catch(error => {
            console.error('Error loading shop details:', error);
            showMessage('Error', 'Failed to load shop details. Please try again.');
        });
    }

    function loadShopProducts(shopId) {
        const sessionToken = localStorage.getItem('sessionToken');
        const productsContainer = document.getElementById('shop-products-container');

        // Show loading indicator
        productsContainer.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading products...</p>
            </div>
        `;

        // Fetch products for this shop
        fetch(`/api/products?shop_id=${shopId}`, {
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.data && data.data.length > 0) {
                const products = data.data;

                // Create a table to display products
                let tableHtml = `
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                products.forEach(product => {
                    tableHtml += `
                        <tr>
                            <td>${product.product_id}</td>
                            <td>${product.name}</td>
                            <td>${product.category || 'N/A'}</td>
                            <td>â‚¹${parseFloat(product.price).toFixed(2)}</td>
                            <td>
                                <span class="badge ${parseInt(product.stock_quantity) <= 5 ? 'bg-warning' : 'bg-success'}">
                                    ${product.stock_quantity}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                    </table>
                `;

                productsContainer.innerHTML = tableHtml;
            } else {
                productsContainer.innerHTML = '<p class="text-center">No products found for this shop.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading shop products:', error);
            productsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load products. Please try again.
                </div>
            `;
        });
    }

    function editShop(shop) {
        // Set form values
        document.getElementById('shop-id').value = shop.shop_id;
        document.getElementById('shop-name').value = shop.name;
        document.getElementById('shop-address').value = shop.address || '';
        document.getElementById('shop-contact').value = shop.contact || '';

        // Set owner if available
        const ownerSelect = document.getElementById('shop-owner');
        if (shop.member_id) {
            // Check if the option exists
            let optionExists = false;
            for (let i = 0; i < ownerSelect.options.length; i++) {
                if (ownerSelect.options[i].value == shop.member_id) {
                    ownerSelect.selectedIndex = i;
                    optionExists = true;
                    break;
                }
            }

            // If option doesn't exist, add it
            if (!optionExists) {
                const option = document.createElement('option');
                option.value = shop.member_id;
                option.textContent = `Member ID: ${shop.member_id}`;
                ownerSelect.appendChild(option);
                ownerSelect.value = shop.member_id;
            }
        }

        // Update modal title
        document.getElementById('shopModalLabel').textContent = 'Edit Shop';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('shopModal'));
        modal.show();
    }

    function showDeleteModal(shop) {
        document.getElementById('delete-shop-id').value = shop.shop_id;
        document.getElementById('delete-shop-name').textContent = `${shop.name} (${shop.shop_id})`;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    function saveShop() {
        const sessionToken = localStorage.getItem('sessionToken');
        const shopId = document.getElementById('shop-id').value;
        const shopName = document.getElementById('shop-name').value;
        const shopAddress = document.getElementById('shop-address').value;
        const shopContact = document.getElementById('shop-contact').value;
        const shopOwner = document.getElementById('shop-owner').value;

        // Validate form
        if (!shopName || !shopAddress || !shopContact || !shopOwner) {
            showMessage('Error', 'Please fill in all required fields');
            return;
        }

        // All users can save shops
        console.log('Saving shop...');

        // Prepare data
        const shopData = {
            name: shopName,
            address: shopAddress,
            contact: shopContact,
            member_id: shopOwner
        };

        let url, method;

        if (shopId) {
            // Update existing shop
            url = `/shops/${shopId}`;
            method = 'PUT';
        } else {
            // Create new shop
            url = '/shops';
            method = 'POST';

            // Generate a shop ID for new shops (limited to 5 chars: SH + 3 digits)
            shopData.shop_id = 'SH' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        }

        // Send request
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': sessionToken
            },
            body: JSON.stringify(shopData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('shopModal'));
                modal.hide();

                // Reload shops
                loadShops();

                // Show success message
                showMessage('Success', shopId ? 'Shop updated successfully' : 'Shop created successfully');
            } else {
                showMessage('Error', data.error || 'Failed to save shop');
            }
        })
        .catch(error => {
            console.error('Error saving shop:', error);
            showMessage('Error', 'Failed to save shop. Please try again.');
        });
    }

    function deleteShop() {
        const sessionToken = localStorage.getItem('sessionToken');
        const shopId = document.getElementById('delete-shop-id').value;

        // All users can delete shops
        console.log('Deleting shop:', shopId);

        // First, find the shop in our local array to have a backup
        const shopToDelete = allShops.find(shop => shop.shop_id === shopId);
        if (shopToDelete) {
            console.log('Found shop to delete:', shopToDelete);
        }

        fetch(`/shops/${shopId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': sessionToken
            }
        })
        .then(response => {
            // Close modal regardless of response
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();

            // Even if there's an error, we'll try to update the UI
            if (!response.ok) {
                console.warn(`Server returned error status: ${response.status}`);
                // If we have the shop locally, remove it from UI anyway
                if (shopToDelete) {
                    removeShopFromUI(shopId);
                    showMessage('Warning', 'Shop may have been deleted, but there was a server error. UI has been updated.');
                } else {
                    showMessage('Error', `Server error (${response.status}). Please try again.`);
                }
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Skip if we already handled the error

            console.log('Delete response:', data);

            if (data.status === 'success') {
                removeShopFromUI(shopId);
                showMessage('Success', 'Shop deleted successfully');
            } else {
                showMessage('Error', data.error || 'Failed to delete shop');
            }
        })
        .catch(error => {
            console.error('Error deleting shop:', error);

            // Even if there's an exception, try to update the UI if we have the shop locally
            if (shopToDelete) {
                removeShopFromUI(shopId);
                showMessage('Warning', 'Shop may have been deleted, but there was an error. UI has been updated.');
            } else {
                showMessage('Error', `Failed to delete shop: ${error.message}. Please try again.`);
            }
        });
    }

    // Helper function to remove a shop from the UI
    function removeShopFromUI(shopId) {
        // Remove the shop from the allShops array
        const shopIndex = allShops.findIndex(shop => shop.shop_id === shopId);
        if (shopIndex !== -1) {
            console.log(`Removing shop ${shopId} from allShops array at index ${shopIndex}`);
            allShops.splice(shopIndex, 1);

            // Also remove from filteredShops if present
            const filteredIndex = filteredShops.findIndex(shop => shop.shop_id === shopId);
            if (filteredIndex !== -1) {
                console.log(`Removing shop ${shopId} from filteredShops array at index ${filteredIndex}`);
                filteredShops.splice(filteredIndex, 1);
            }

            // Update the display without reloading from server
            displayShops(filteredShops, currentPage);
            return true;
        } else {
            console.warn(`Shop ${shopId} not found in allShops array, reloading from server`);
            // If we can't find the shop in our array, reload everything
            loadShops();
            return false;
        }
    }

    // Helper function to show messages
    function showMessage(title, message) {
        const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
        document.getElementById('messageModalLabel').textContent = title;
        document.getElementById('messageModalBody').textContent = message;
        messageModal.show();
    }
</script>
{% endblock %}
